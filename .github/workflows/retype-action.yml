name: Publish Retype powered website to all-inkl

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  publish:
    name: Deploy on all-inkl
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build pages
        uses: retypeapp/action-build@latest

      - name: Store in branch
        uses: retypeapp/action-github-pages@latest
        with:
          branch: retype
          update-branch: true

      - name: Refresh server worktree
        uses: appleboy/ssh-action@master
        with:
          host: w01c4ca9.kasserver.com
          username: ssh-w02125c1
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            # Debug (damit wir im Log sofort sehen, ob Pfade passen)
            whoami
            pwd
            ls -la /www/htdocs/w02125c1 || true
            ls -la /www/htdocs/w02125c1/website || true

            # Sicherstellen, dass Worktree/Repo existieren
            test -d /www/htdocs/w02125c1/.repo
            test -f /www/htdocs/w02125c1/website/.git

            # retype-Branch vom Server aktualisieren
            git -C /www/htdocs/w02125c1/.repo fetch origin retype

            # Website-Verzeichnis auf neuesten Stand setzen
            git -C /www/htdocs/w02125c1/website reset --hard origin/retype
            git -C /www/htdocs/w02125c1/website clean -fdx

            # .htaccess neu schreiben
            cat > /www/htdocs/w02125c1/website/.htaccess <<'EOF'
            <FilesMatch "^\.git">
              Require all denied
            </FilesMatch>

            Options -Indexes

            AuthUserFile /www/htdocs/w02125c1/website/.htpasswd
            AuthGroupFile /dev/null
            AuthName "bitte Zugangsdaten eingeben"
            AuthType Basic
            require valid-user
            EOF

            # .htpasswd neu schreiben (Hash kommt aus GitHub Secret)
            # WICHTIG: <<'EOF' verhindert, dass $2y$... kaputt interpretiert wird
            cat > /www/htdocs/w02125c1/website/.htpasswd <<'EOF'
            ${{ secrets.HTPASSWD_LINE }}
            EOF
